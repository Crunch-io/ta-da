<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Adding Variables • Crunch</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="48x48" href="../favicon-48x48.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/simplex/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Adding Variables">
<meta property="og:description" content="The crunch package makes it easy for you to derive new variables in your dataset. These derived variables retain their functional connection on the server, such that changes to the input variables automatically propagate to the derived variable.">
<meta property="og:image" content="http://crunch.io/r/crunch/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-50332119-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-50332119-2');
</script>
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">Crunch</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.31.1.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/crunch.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="divider">
    </li>
<li class="dropdown-header">Getting started</li>
    <li>
      <a href="../articles/variables.html">Crunch Variables</a>
    </li>
    <li>
      <a href="../articles/array-variables.html">Array Variables</a>
    </li>
    <li>
      <a href="../articles/variable-order.html">Variable Folders and Organization</a>
    </li>
    <li>
      <a href="../articles/projects.html">Organizing Datasets in Projects</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Exploring and analyzing</li>
    <li>
      <a href="../articles/derive.html">Adding Variables</a>
    </li>
    <li>
      <a href="../articles/analyze.html">Analyzing Crunch Data</a>
    </li>
    <li>
      <a href="../articles/filters.html">Filtering Data</a>
    </li>
    <li>
      <a href="../articles/subtotals.html">Subtotals and Headings</a>
    </li>
    <li>
      <a href="../articles/export.html">Exporting Data</a>
    </li>
    <li>
      <a href="../articles/fork-and-merge.html">Fork and Merge a Dataset</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Going deeper</li>
    <li>
      <a href="../articles/crunch-internals.html">Crunch Internals</a>
    </li>
    <li>
      <a href="../articles/abstract-categories.html">Abstract Categories</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Cookbooks</li>
    <li>
      <a href="../articles/deck-cookbook.html">Crunch Deck Cookbook</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/Crunch-io/rcrunch/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>

    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Adding Variables</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Crunch-io/rcrunch/blob/master/vignettes/derive.Rmd" class="external-link"><code>vignettes/derive.Rmd</code></a></small>
      <div class="hidden name"><code>derive.Rmd</code></div>

    </div>

    
    
<p><a href="variable-order.html">Previous: variable organization</a></p>
<p>One of the powerful features of working with Crunch is that you and
all of your collaborators work off of the same data, whether you use the
web client or use R. Circumstances may arise in which you are working in
R and want to add or modify variables in a Crunch dataset, and the
<code>crunch</code> package facilitates that. It provides an idiomatic R
interface to manipulating a Dataset, doing so efficiently, without
copying data off of the server to transform it.</p>
<div class="section level2">
<h2 id="materialized-vs-derived-variables">Materialized vs Derived Variables<a class="anchor" aria-label="anchor" href="#materialized-vs-derived-variables"></a>
</h2>
<p>A powerful feature of crunch is that when you create variables
derived from other variables, they retain their functional connection on
the server, such that changes to the input variables automatically
propagate to the derived variable. In contrast, materialized variables
are saved as the data and so do not update when the underly data
updates.</p>
<p>The default is to create derived variables. However we’ve found that
it is often preferable to work wit the more performant materialized
variables and so there is a global default option that you can set to
change the behavior. Also, most variable creation functions have a
derived argument which you can set on a per-variable basis, or if you’re
working with an expression directly, you can pass a <code>derived</code>
argument to the <code><a href="../reference/VariableDefinition.html">VariableDefinition()</a></code> function.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Using the `derive` argument in `VariableDefinition()`</span></span>
<span><span class="va">ds</span><span class="op">$</span><span class="va">force_materialized_age</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/VariableDefinition.html">VariableDefinition</a></span><span class="op">(</span><span class="fl">2015</span> <span class="op">-</span> <span class="va">ds</span><span class="op">$</span><span class="va">birthyr</span>, derived <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Using the `derive` argument in `deriveArray()`</span></span>
<span><span class="va">ds</span><span class="op">$</span><span class="va">force_materialiazed_array</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/deriveArray.html">deriveArray</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">ds</span><span class="op">$</span><span class="va">v1</span>, <span class="va">ds</span><span class="op">$</span><span class="va">v2</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"v_arry"</span>, derived <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Could set the global default to FALSE (materialized)</span></span>
<span><span class="co"># set_crunch_opts(crunch.default.derived = FALSE)</span></span>
<span><span class="co"># (Note that the rest of this vignette assumes derived)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="creating-derived-variables">Creating derived variables<a class="anchor" aria-label="anchor" href="#creating-derived-variables"></a>
</h2>
<p>In our sample dataset, we don’t have an “Age” variable, but we do
have “Birth Year” (<code>birthyr</code>). We can create an age variable
simply by taking the current year and subtracting the “Birth Year”
variable from it–just as you would do if you were working with a
<code>data.frame</code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ds</span><span class="op">$</span><span class="va">age</span> <span class="op">&lt;-</span> <span class="fl">2015</span> <span class="op">-</span> <span class="va">ds</span><span class="op">$</span><span class="va">birthyr</span></span></code></pre></div>
<p>Now, we have an age variable, and it looks like we’d expect it would
relative to <code>birthyr</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ds</span><span class="op">$</span><span class="va">age</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">##   22.00   38.00   48.50   49.62   59.75   90.00</span></span></code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ds</span><span class="op">$</span><span class="va">birthyr</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">##    1925    1955    1966    1965    1977    1993</span></span></code></pre>
<p>Age is now a derived variable, functionally linked to
<code>birthyr</code> on the server. Note that in order to create
<code>age</code>, we didn’t pull any values off of the server; we just
supplied the derivation expression.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="fl">2015</span> <span class="op">-</span> <span class="va">ds</span><span class="op">$</span><span class="va">birthyr</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "CrunchExpr"</span></span>
<span><span class="co">## attr(,"package")</span></span>
<span><span class="co">## [1] "crunch"</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="updating-values">Updating values<a class="anchor" aria-label="anchor" href="#updating-values"></a>
</h2>
<p>We can also use these expressions to update values. Suppose, just for
demonstration purposes, that we want to truncate the range of the
<code>birthyr</code> variable and set it to 1945 everywhere where it is
less than 1945. We can once again write the R code we’d write if we were
working with a <code>data.frame</code>, even though we’re working with a
Crunch dataset:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ds</span><span class="op">$</span><span class="va">birthyr</span><span class="op">[</span><span class="va">ds</span><span class="op">$</span><span class="va">birthyr</span> <span class="op">&lt;</span> <span class="fl">1945</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1945</span></span></code></pre></div>
<p>If we look at the summary again, we’ll see that our data have been
updated, and the minimum Birth Year is now 1945.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ds</span><span class="op">$</span><span class="va">birthyr</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">##    1945    1955    1966    1966    1977    1993</span></span></code></pre>
<p>Not only that: since <code>age</code> is a function of
<code>birthyr</code> on the server, its values also update now that
we’ve modified <code>birthyr</code>. Max age is now 70, or 2015 -
1945.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ds</span><span class="op">$</span><span class="va">age</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">##   22.00   38.00   48.50   48.98   59.75   70.00</span></span></code></pre>
<p>Once again, we’ve done this operation by turning idiomatic R
expressions into Crunch expression syntax.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">ds</span><span class="op">$</span><span class="va">birthyr</span> <span class="op">&lt;</span> <span class="fl">1945</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "CrunchLogicalExpr"</span></span>
<span><span class="co">## attr(,"package")</span></span>
<span><span class="co">## [1] "crunch"</span></span></code></pre>
<p>The work gets done without having to pull data off of the server.</p>
<p><a href="analyze.html">Next: analyzing data</a></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Greg Freedman Ellis, Jonathan Keane, Mike Malecki, Neal Richardson, Gordon Shotwell, Aljaž Sluga.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

      </footer>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({


    apiKey: '9fbcb3ae4d05600402e31f66b9b9501e',
    indexName: 'crunch',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
